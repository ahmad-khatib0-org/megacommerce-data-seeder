# Stage 1: Builder
FROM python:3.12-alpine AS builder

WORKDIR /app

# Install build dependencies
RUN apk add --no-cache \
    build-base \
    git \
    curl \
    postgresql-dev \
    libffi-dev

COPY requirements/base.txt requirements/git.txt ./

RUN pip install --user --no-cache-dir --no-deps -r git.txt && \
    pip install --user --no-cache-dir -r base.txt

# Stage 2: Runtime (TINIER!)
FROM python:3.12-alpine

WORKDIR /app

# Install runtime dependencies
RUN apk add --no-cache \
    postgresql-client \
    curl \
    libpq

# Copy installed packages
COPY --from=builder /root/.local /root/.local
ENV PATH=/root/.local/bin:$PATH

# Copy source
COPY main.py .
COPY seeders/ ./seeders/
COPY general_utils/ ./general_utils/
COPY models/ ./models/

ENV PYTHONUNBUFFERED=1 \
    PYTHONDONTWRITEBYTECODE=1

CMD ["python", "main.py"]
